<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>relbp.me</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="relbp.me - A vibrant, secure LittleBigPlanet 3 community!" />
  <style>
    /* Clean, LBP-inspired styles */
    body { font-family: 'Comic Sans MS', Arial, sans-serif; margin: 0; background: linear-gradient(135deg, #f0f4ff, #d4eaff); color: #222; overflow-x: hidden; }
    .container { padding: 2.5rem; animation: fadeIn 0.5s ease-out; position: relative; z-index: 10; min-height: 100vh; }
    .card { background: #fff; margin: 1.5rem 0; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.3s ease, backdrop-filter 0.3s; }
    .card:hover { transform: translateY(-8px); backdrop-filter: blur(5px); }
    /* Navbar */
    nav .navbar { background: #1a1a1a; box-shadow: 0 3px 6px rgba(0,0,0,0.2); position: relative; z-index: 20; }
    nav .navbar ul { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; }
    nav .navbar li { padding: 1rem; }
    nav .navbar a { color: #fff; text-decoration: none; font-size: 1.2rem; transition: color 0.2s; }
    nav .navbar a:hover { color: #2ecc71; }
    /* Sidebar */
    .sidebar-offcanvas { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background: #1a1a1a; overflow-y: auto; transition: left 0.3s ease; backdrop-filter: blur(10px); z-index: 30; }
    .sidebar-offcanvas.open { left: 0; }
    .sidebar-offcanvas ul.nav li { margin: 0.8rem 1rem; }
    .sidebar-offcanvas ul.nav li button { width: 100%; text-align: left; background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; border: none; padding: 1rem; border-radius: 10px; font-size: 1.2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s, transform 0.2s, box-shadow 0.2s; }
    .sidebar-offcanvas ul.nav li button:hover { background: linear-gradient(135deg, #27ae60, #219653); transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 10px #2ecc71; }
    .sidebar-offcanvas ul.nav li a { color: #fff; text-decoration: none; display: block; }
    .sidebar-toggle { position: fixed; top: 1.5rem; left: 1.5rem; z-index: 40; background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 10px; cursor: pointer; font-size: 1.3rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s; }
    .sidebar-toggle:hover { transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 10px #2ecc71; }
    /* Animations */
    .sackboy { width: 100px; height: 100px; background: url('https://via.placeholder.com/100?text=Sackboy') no-repeat center; animation: bounce 1.5s infinite; margin: 1.5rem auto; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    /* Video background */
    .video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; opacity: 0; transition: opacity 1s ease; }
    .video-background.loaded { opacity: 0.8; } /* Slightly transparent for visibility */
    .video-background iframe { width: 100%; height: 100%; border: none; }
    .video-background img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .video-background iframe:not([src]) + img { display: block; }
    /* Search and buttons */
    .dropdown-menu { position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #ccc; min-width: 250px; z-index: 1000; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); backdrop-filter: blur(5px); transition: opacity 0.3s; }
    .search-form { padding: 10px; }
    .input-group { display: flex; align-items: center; }
    .search-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 10px 0 0 10px; font-family: 'Comic Sans MS', Arial, sans-serif; background: #f9fbff; font-size: 1.1rem; }
    .input-group-btn { display: flex; }
    .btn { cursor: pointer; padding: 10px 16px; border: none; font-family: 'Comic Sans MS', Arial, sans-serif; font-size: 1.1rem; transition: background 0.2s, transform 0.2s, box-shadow 0.2s; border-radius: 10px; }
    .btn:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 0 10px #2ecc71; }
    .btn-bright-green { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .btn-clear { background: transparent; }
    .reset { background: #ccc; border-radius: 10px; }
    .search-submit::after { content: "üîç"; }
    .icon-bar { background: #fff; display: block; width: 22px; height: 2px; margin: 5px 0; }
    /* Server status dashboard */
    .server-status { background: linear-gradient(135deg, #e6f3ff, #d4eaff); padding: 2rem; border-radius: 12px; margin-top: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .status-card { background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .status-card .online { color: #2ecc71; font-weight: bold; }
    .status-card .offline { color: #e74c3c; font-weight: bold; }
    .status-card p { margin: 0.5rem 0; font-size: 1.2rem; }
    /* General */
    a { color: #2ecc71; text-decoration: none; }
    a:hover { color: #27ae60; }
    h1, h2, h3 { font-family: 'Comic Sans MS', Arial, sans-serif; color: #222; margin: 0.8rem 0; }
    button { font-family: 'Comic Sans MS', Arial, sans-serif; }
    /* Ensure visibility and prevent sticking */
    * { box-sizing: border-box; }
    main { margin-left: 0; transition: margin-left 0.3s ease; }
    main.sidebar-open { margin-left: 300px; }
    .content-overlay { background: rgba(255, 255, 255, 0.9); padding: 1.5rem; border-radius: 12px; } /* Ensures text visibility over video */
  </style>
</head>
<body class="lbp logged-out homepage" data-controller="home" data-ext-base-url="/api" data-context-path="">
  <div class="video-background">
    <iframe onload="this.parentNode.classList.add('loaded')" src="https://www.youtube.com/embed/qovNaHl-Ko4?autoplay=1&mute=1&loop=1&playlist=qovNaHl-Ko4&controls=0" allow="autoplay"></iframe>
    <img src="https://via.placeholder.com/1920x1080?text=LBP+Intro+Fallback" alt="Fallback">
  </div>
  <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞ Menu</button>
  <div class="bgr">
    <nav>
      <div class="navbar primary hidden-lg hidden-md hidden-sm" role="navigation">
        <div class="container">
          <div class="navbar pull-left logo">
            <a href="/" data-link><img src="https://via.placeholder.com/60?text=Logo" alt="relbp.me"></a>
          </div>
          <div class="navbar-header">
            <button type="button" class="navbar-toggle navigation-hotspot" onclick="toggleSidebar()">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
            </button>
            <div class="quick-search btn-group">
              <button type="button" class="btn btn-clear dropdown-toggle icon-text search sm" onclick="openSearch(event)"></button>
              <div class="dropdown-menu" style="display:none;" id="search-dropdown">
                <div class="search-form" data-stoppropagation="true">
                  <form method="GET" action="/search/v" autocomplete="off" onsubmit="return onSearch(event)">
                    <fieldset>
                      <div class="input-group">
                        <input type="text" name="q" class="search-input form-control" placeholder="Quick search">
                        <span class="input-group-btn">
                          <button class="reset" type="reset" style="display:none;"></button>
                          <button type="submit" class="btn btn-bright-green icon-text sm search search-submit"></button>
                        </span>
                      </div>
                    </fieldset>
                  </form>
                </div>
              </div>
            </div>
            <div class="autopilot">
              <button class="btn btn-clear icon-img icon-content sm playworld disabled" href="#autopilotmodalsignedout">Autopilot</button>
            </div>
          </div>
        </div>
      </div>
      <div class="secondary-wrapper hidden-xs">
        <div class="navbar secondary not-homepage container" role="navigation">
          <ul class="nav navbar-nav">
            <li id="home-link"><button class="btn btn-bright-green"><a href="/" data-link class="nav-link">Home</a></button></li>
            <li id="profile-link">
              <div class="autopilot hidden-xs"><button class="btn btn-clear icon-img icon-content sm playworld disabled">Autopilot</button></div>
              <div id="signin-link"><button class="btn btn-bright-green"><a href="/signin" data-link title="Sign in">Sign In</a></button></div>
              <button class="btn btn-bright-green"><a class="signed-out nav-link" href="/profile" data-link>My Profile</a></button>
            </li>
            <li id="videos-link"><button class="btn btn-bright-green"><a href="/videos" data-link class="nav-link">Videos</a></button></li>
            <li id="levels-link"><button class="btn btn-bright-green"><a href="/levels" data-link class="nav-link">Levels</a></button></li>
            <li id="community-link"><button class="btn btn-bright-green"><a href="/community" data-link class="nav-link">Community</a></button></li>
            <li id="tutorial-link"><button class="btn btn-bright-green"><a href="/videos/tutorial" data-link class="nav-link">Tutorials</a></button></li>
            <li id="copyright-link"><button class="btn btn-bright-green"><a href="/copyright" data-link class="nav-link">Copyright</a></button></li>
          </ul>
          <div class="quick-search btn-group hidden-xs">
            <button type="button" class="btn btn-clear dropdown-toggle icon-text search sm" onclick="openSearch(event)"></button>
            <div class="dropdown-menu" style="display:none;" id="search-dropdown-2">
              <div class="search-form" data-stoppropagation="true">
                <form method="GET" action="/search/v" autocomplete="off" onsubmit="return onSearch(event)">
                  <fieldset>
                    <div class="input-group">
                      <input type="text" name="q" class="search-input form-control" placeholder="Quick search">
                      <span class="input-group-btn">
                        <button class="reset" type="reset" style="display:none;"></button>
                        <button type="submit" class="btn btn-bright-green icon-text sm search search-submit"></button>
                      </span>
                    </div>
                  </fieldset>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </div>

  <div class="sidebar-offcanvas" id="sidebar">
    <div class="pull-left width100 clear">
      <ul class="nav top-oc">
        <li class="home-link"><button class="btn btn-bright-green"><a href="/" data-link>Home</a></button></li>
        <li class="community-link"><button class="btn btn-bright-green"><a href="/community" data-link>Community</a></button></li>
        <li class="levels-link"><button class="btn btn-bright-green"><a href="/levels" data-link>Levels</a></button></li>
        <li class="video-link"><button class="btn btn-bright-green"><a href="/videos" data-link>Videos</a></button></li>
        <li class="tutorial-link"><button class="btn btn-bright-green"><a href="/videos/tutorial" data-link>Tutorials</a></button></li>
        <li class="profile-link"><button class="btn btn-bright-green"><a href="/profile" data-link>My Profile</a></button></li>
        <li class="signin-link"><button class="btn btn-bright-green"><a href="/signin" data-link>Sign In</a></button></li>
        <li class="signout-link"><button class="btn btn-bright-green"><a href="/signout" data-link>Sign Out</a></button></li>
        <li class="copyright-link"><button class="btn btn-bright-green"><a href="/copyright" data-link>Copyright</a></button></li>
        <li class="lbp-link"><button class="btn btn-bright-green"><a href="http://littlebigplanet.com/" target="_blank">LBP.com</a></button></li>
      </ul>
    </div>
  </div>

  <main id="app" class="container">
    <!-- Dynamic content will load here -->
  </main>

  <script>
    // Backend (Node.js/Express with forced LBP 3 server connection)
    if (typeof require !== 'undefined') {
      const express = require('express');
      const cors = require('cors');
      const path = require('path');
      const sanitizeHtml = require('sanitize-html');
      const app = express();
      app.use(cors());
      app.use(express.json());
      // Game server configuration (Beacon/Project Lighthouse for LBP 3)
      const BEACON_SERVER = 'https://beacon.lbpunion.com';
      const gameConfig = {
        serverUrl: BEACON_SERVER,
        authEndpoint: `${BEACON_SERVER}/api/v1/auth`,
        levelsEndpoint: `${BEACON_SERVER}/api/v1/levels`,
        profilesEndpoint: `${BEACON_SERVER}/api/v1/profiles`,
        sanitizeOptions: {
          allowedTags: [],
          allowedAttributes: {}
        }
      };
      // Forced game server connection
      async function connectToBeacon() {
        try {
          const response = await fetch(`${gameConfig.serverUrl}/api/v1/status`, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          if (!response.ok) throw new Error('Beacon server unavailable');
          return { status: 'Connected', message: 'Successfully connected to Beacon server' };
        } catch (err) {
          console.error('Beacon connection failed:', err);
          return { status: 'Failed', message: 'Ensure game client is patched for Beacon' };
        }
      }
      connectToBeacon().then(result => console.log('Beacon:', result.status));
      // Secure API endpoints
      app.get('/api/homepage', (req, res) => {
        res.json({ title: 'Welcome to relbp.me', description: 'A vibrant, secure LittleBigPlanet 3 community!' });
      });
      app.get('/api/levels', async (req, res) => {
        try {
          const response = await fetch(gameConfig.levelsEndpoint, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          const data = await response.json();
          res.json(data.map(item => ({
            id: sanitizeHtml(item.id, gameConfig.sanitizeOptions),
            name: sanitizeHtml(item.name, gameConfig.sanitizeOptions),
            summary: sanitizeHtml(item.summary, gameConfig.sanitizeOptions),
            description: sanitizeHtml(item.description, gameConfig.sanitizeOptions)
          })));
        } catch (err) {
          res.json([
            { id: '1', name: 'Sackboy Adventure', summary: 'A fun level', description: 'Explore a creative world.' },
            { id: '2', name: 'Dreamscape Dash', summary: 'Epic challenge', description: 'Challenge your skills.' }
          ]);
        }
      });
      app.get('/api/videos', (req, res) => {
        res.json([
          { id: '1', title: 'Epic Gameplay', description: 'Gameplay showcase.' },
          { id: '2', title: 'Creative Builds', description: 'Amazing creations.' }
        ]);
      });
      app.get('/api/videos/tutorial', (req, res) => {
        res.json([
          { id: '1', title: 'Level Creation 101', description: 'Learn to create levels.' }
        ]);
      });
      app.get('/api/community', (req, res) => {
        res.json([
          { name: 'Sackboy Hub', description: 'Connect with LBP fans!' }
        ]);
      });
      app.get('/api/users/:username', async (req, res) => {
        const username = sanitizeHtml(req.params.username, gameConfig.sanitizeOptions);
        try {
          const response = await fetch(`${gameConfig.profilesEndpoint}/${username}`, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          const data = await response.json();
          res.json({ username, bio: sanitizeHtml(data.bio, gameConfig.sanitizeOptions) });
        } catch (err) {
          res.json({ username, bio: `Bio for ${username}` });
        }
      });
      app.get('/api/user/session', (req, res) => {
        res.json({ loggedIn: false, username: '' });
      });
      app.get('/api/search/:type', (req, res) => {
        const type = sanitizeHtml(req.params.type, gameConfig.sanitizeOptions);
        const q = sanitizeHtml(req.query.q || '', gameConfig.sanitizeOptions);
        const tab = type === 'u' ? 'users' : type === 'l' ? 'levels' : 'videos';
        res.json([{ [tab === 'users' ? 'username' : tab === 'levels' ? 'name' : 'title']: `Result for ${q}` }]);
      });
      app.get('/api/levels/:id', async (req, res) => {
        const id = sanitizeHtml(req.params.id, gameConfig.sanitizeOptions);
        try {
          const response = await fetch(`${gameConfig.levelsEndpoint}/${id}`, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          const data = await response.json();
          res.json({ name: sanitizeHtml(data.name, gameConfig.sanitizeOptions), description: sanitizeHtml(data.description, gameConfig.sanitizeOptions) });
        } catch (err) {
          res.json({ name: `Level ${id}`, description: `Description for level ${id}` });
        }
      });
      app.get('/api/videos/:id', (req, res) => {
        const id = sanitizeHtml(req.params.id, gameConfig.sanitizeOptions);
        res.json({ title: `Video ${id}`, description: `Description for video ${id}` });
      });
      app.get('/api/server-status', async (req, res) => {
        try {
          const response = await fetch(`${BEACON_SERVER}/api/v1/status`, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          const data = await response.json();
          res.json({
            beacon: {
              status: sanitizeHtml(data.status, gameConfig.sanitizeOptions),
              players: parseInt(data.players || 0),
              levels: parseInt(data.levels || 0)
            },
            lastChecked: new Date().toISOString()
          });
        } catch (err) {
          res.json({
            beacon: { status: 'Offline', players: 0, levels: 0 },
            lastChecked: new Date().toISOString()
          });
        }
      });
      app.get('*', (req, res) => {
        res.sendFile(path.join(__dirname, 'index.html'));
      });
      const PORT = process.env.PORT || 10000;
      app.listen(PORT, '0.0.0.0', () => console.log(`Server on port ${PORT}`));
    }

    // Frontend (Client-side routing)
    const API = '/api';

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const main = document.querySelector('main');
      sidebar.classList.toggle('open');
      main.classList.toggle('sidebar-open');
      sidebar.style.backdropFilter = sidebar.classList.contains('open') ? 'blur(10px)' : 'none';
    }

    function openSearch(e) {
      const d = e.target.closest('.quick-search').querySelector('.dropdown-menu');
      d.style.display = d.style.display === 'block' ? 'none' : 'block';
    }

    function onSearch(e) {
      e.preventDefault();
      let q = e.target.q.value.replace(/[<>]/g, '');
      if (!q) return false;
      history.pushState(null, null, `/search/v?q=${encodeURIComponent(q)}`);
      router();
      return false;
    }

    const app = document.getElementById('app');

    async function routeHome() {
      try {
        const [res, statusRes] = await Promise.all([
          fetch(`${API}/homepage`).catch(() => ({ ok: false })),
          fetch(`${API}/server-status`).catch(() => ({ ok: false }))
        ]);
        const d = res.ok ? await res.json() : { title: 'Welcome', description: 'Error loading homepage' };
        const status = statusRes.ok ? await statusRes.json() : { beacon: { status: 'Offline', players: 0, levels: 0 }, lastChecked: new Date().toISOString() };
        app.innerHTML = `
          <div class="content-overlay">
            <div class="sackboy"></div>
            <h1>${d.title}</h1>
            <p>${d.description}</p>
            <div class="server-status">
              <h2>Server Status</h2>
              <div class="status-card">
                <p><strong>Beacon Server</strong>: <span class="${status.beacon.status.toLowerCase()}">${status.beacon.status}</span></p>
                <p>Players Online: ${status.beacon.players}</p>
                <p>Levels Available: ${status.beacon.levels}</p>
                <p>Last Checked: ${new Date(status.lastChecked).toLocaleString()}</p>
              </div>
              <p><a href="https://discord.com/invite/lbpunion" target="_blank">Join our Discord for live updates!</a></p>
              <button class="btn btn-bright-green" onclick="connectToGameServer()">Connect to LBP 3 Servers</button>
            </div>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load homepage: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeLevels() {
      try {
        const res = await fetch(`${API}/levels`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `<div class="content-overlay"><h1>Levels</h1>` + (d.length ? d.map(l => `<div class="card"><h3><a href="/l/${l.id}" data-link>${l.name}</a></h3><p>${l.summary}</p><button class="btn btn-bright-green">Play Level</button></div>`).join('') : '<p>No levels available</p>') + `<button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load levels: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeVideos() {
      try {
        const res = await fetch(`${API}/videos`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `<div class="content-overlay"><h1>Videos</h1>` + (d.length ? d.map(v => `<div class="card"><h3><a href="/v/${v.id}" data-link>${v.title}</a></h3><p>${v.description}</p><button class="btn btn-bright-green">Watch Video</button></div>`).join('') : '<p>No videos available</p>') + `<button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load videos: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeTutorials() {
      try {
        const res = await fetch(`${API}/videos/tutorial`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `<div class="content-overlay"><h1>Tutorials</h1>` + (d.length ? d.map(v => `<div class="card"><h3>${v.title}</h3><p>${v.description}</p><button class="btn btn-bright-green">Watch Tutorial</button></div>`).join('') : '<p>No tutorials available</p>') + `<button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load tutorials: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeCommunity() {
      try {
        const res = await fetch(`${API}/community`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `<div class="content-overlay"><h1>Community</h1>` + (d.length ? d.map(c => `<div class="card"><h3>${c.name}</h3><p>${c.description}</p><button class="btn btn-bright-green">Join Community</button></div>`).join('') : '<p>No community data available</p>') + `<button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load community: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeUser(username) {
      try {
        const res = await fetch(`${API}/users/${encodeURIComponent(username.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const u = res.ok ? await res.json() : { username: 'Unknown', bio: 'User not found' };
        app.innerHTML = `<div class="content-overlay"><h1>${u.username}</h1><p>${u.bio}</p><button class="btn btn-bright-green">View Profile</button><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load user: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeVideo(id) {
      try {
        const res = await fetch(`${API}/videos/${encodeURIComponent(id.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const v = res.ok ? await res.json() : { title: 'Unknown', description: 'Video not found' };
        app.innerHTML = `<div class="content-overlay"><h1>${v.title}</h1><p>${v.description}</p><button class="btn btn-bright-green">Watch Video</button><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load video: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeLevel(id) {
      try {
        const res = await fetch(`${API}/levels/${encodeURIComponent(id.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const l = res.ok ? await res.json() : { name: 'Unknown', description: 'Level not found' };
        app.innerHTML = `<div class="content-overlay"><h1>${l.name}</h1><p>${l.description}</p><button class="btn btn-bright-green">Play Level</button><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load level: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeProfile() {
      try {
        const res = await fetch(`${API}/user/session`, { credentials: 'include' }).catch(() => ({ ok: false }));
        const u = res.ok ? await res.json() : { loggedIn: false };
        app.innerHTML = `<div class="content-overlay">` + (u.loggedIn ? `<h1>${u.username}</h1><p>Welcome back!</p><button class="btn btn-bright-green">Edit Profile</button>` : `<p>Not signed in. <a href="/signin" data-link>Sign in</a></p>`) + `<button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load profile: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeSearch(type, q) {
      try {
        const tab = type === 'u' ? 'users' : type === 'l' ? 'levels' : 'videos';
        const res = await fetch(`${API}/search/${type}?q=${encodeURIComponent(q.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `<div class="content-overlay"><h1>Search ${tab} for "${q}"</h1>` + (d.length ? d.map(i => `<div class="card"><h3>${i.username || i.name || i.title}</h3><button class="btn btn-bright-green">View ${tab === 'users' ? 'Profile' : tab === 'levels' ? 'Level' : 'Video'}</button></div>`).join('') : '<p>No results found</p>') + `<button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load search: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }
    async function routeWelcome() {
      app.innerHTML = `<div class="content-overlay"><h1>Welcome!</h1><p>You just signed in.</p><button class="btn btn-bright-green"><a href="/" data-link>Go to Home</a></button></div>`;
    }
    async function routeSignIn() {
      app.innerHTML = `
        <div class="content-overlay">
          <h1>Sign In</h1>
          <p>Connect to LBP 3 servers via Beacon.</p>
          <button class="btn btn-bright-green" onclick="connectToGameServer()">Sign In with Beacon</button>
          <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
        </div>
      `;
    }
    async function routeSignOut() {
      app.innerHTML = `<div class="content-overlay"><h1>Sign Out</h1><p>You have been signed out.</p><button class="btn btn-bright-green"><a href="/" data-link>Return to Home</a></button></div>`;
    }
    async function routeCopyright() {
BAD:       app.innerHTML = `
        <div class="content-overlay">
          <h1>Copyright</h1>
          <p>¬© 2025 relbp.me. All rights reserved. This site is an original creation by the relbp.me team, dedicated to the LittleBigPlanet 3 community. Not affiliated with Sony Interactive Entertainment or Media Molecule.</p>
          <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
        </div>
      `;
    }

    async function connectToGameServer() {
      try {
        const response = await fetch('https://beacon.lbpunion.com/api/v1/auth', {
          method: 'POST',
          headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' },
          body: JSON.stringify({ client: 'web' })
        });
        if (!response.ok) throw new Error('Authentication failed');
        alert('Connected to Beacon server! Patch your LBP 3 client (PS3/RPCS3/Vita) per LBP Union tutorials: https://www.lbpunion.com');
      } catch (err) {
        alert('Failed to connect to Beacon server. Ensure your LBP 3 client is patched: https://www.lbpunion.com');
      }
    }

    async function router() {
      app.innerHTML = `<div class="content-overlay"><p>Loading...</p></div>`;
      try {
        const path = location.pathname;
        const qs = location.search;
        document.querySelector('.video-background').style.display = path === '/' || path === '' ? 'block' : 'none';
        if (path === '/' || path === '') return routeHome();
        if (path === '/levels') return routeLevels();
        if (path === '/videos') return routeVideos();
        if (path === '/videos/tutorial') return routeTutorials();
        if (path === '/community') return routeCommunity();
        if (path === '/profile') return routeProfile();
        if (path === '/welcome') return routeWelcome();
        if (path === '/signin') return routeSignIn();
        if (path === '/signout') return routeSignOut();
        if (path === '/copyright') return routeCopyright();
        let m;
        if (m = path.match(/^\/u\/([^\/]+)$/)) return routeUser(m[1]);
        if (m = path.match(/^\/v\/([^\/]+)$/)) return routeVideo(m[1]);
        if (m = path.match(/^\/l\/([^\/]+)$/)) return routeLevel(m[1]);
        if (m = path.match(/^\/search\/([luv])/) && qs.match(/q=([^&]+)/)) {
          return routeSearch(m[1], decodeURIComponent(qs.split('q=')[1]));
        }
        app.innerHTML = `<div class="content-overlay"><h1>404 Not Found</h1><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load content: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    document.body.addEventListener('click', e => {
      const a = e.target.closest('a[data-link]');
      if (a) {
        e.preventDefault();
        history.pushState(null, null, a.getAttribute('href'));
        router();
      }
    });

    window.addEventListener('popstate', router);

    router();
  </script>
</body>
</html>
