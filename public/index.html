<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>relbp.me</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="relbp.me - A vibrant, secure LittleBigPlanet 3 community!" />
  <style>
    /* Base styles for LBP-inspired aesthetic */
    body { font-family: 'Comic Sans MS', Arial, sans-serif; margin: 0; background: linear-gradient(135deg, #f0f4ff, #d4eaff); color: #222; overflow-x: hidden; }
    .container { padding: 2.5rem; animation: fadeIn 0.5s ease-out; position: relative; z-index: 10; min-height: 100vh; }
    .card { background: #fff; margin: 1.5rem 0; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.3s ease, backdrop-filter 0.3s; }
    .card:hover { transform: translateY(-8px); backdrop-filter: blur(5px); }
    /* Navbar styles for top navigation */
    nav .navbar { background: #1a1a1a; box-shadow: 0 3px 6px rgba(0,0,0,0.2); position: relative; z-index: 20; }
    nav .navbar ul { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; }
    nav .navbar li { padding: 1rem; }
    nav .navbar a { color: #fff; text-decoration: none; font-size: 1.2rem; transition: color 0.2s; }
    nav .navbar a:hover { color: #2ecc71; }
    /* Sidebar styles for navigation */
    .sidebar-offcanvas { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background: #1a1a1a; overflow-y: auto; transition: left 0.3s ease; backdrop-filter: blur(10px); z-index: 30; }
    .sidebar-offcanvas.open { left: 0; }
    .sidebar-offcanvas ul.nav li { margin: 0.8rem 1rem; }
    .sidebar-offcanvas ul.nav li button { width: 100%; text-align: left; background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; border: none; padding: 1rem; border-radius: 10px; font-size: 1.2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s, transform 0.2s, box-shadow 0.2s; }
    .sidebar-offcanvas ul.nav li button:hover { background: linear-gradient(135deg, #27ae60, #219653); transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 10px #2ecc71; }
    .sidebar-offcanvas ul.nav li a { color: #fff; text-decoration: none; display: block; }
    .sidebar-toggle { position: fixed; top: 1.5rem; left: 1.5rem; z-index: 40; background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 10px; cursor: pointer; font-size: 1.3rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s, box-shadow 0.2s; }
    .sidebar-toggle:hover { transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 10px #2ecc71; }
    /* Animations for interactive elements */
    .sackboy { width: 100px; height: 100px; background: url('https://via.placeholder.com/100?text=Sackboy') no-repeat center; animation: bounce 1.5s infinite; margin: 1.5rem auto; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    /* Video background for homepage */
    .video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; opacity: 0; transition: opacity 1s ease; }
    .video-background.loaded { opacity: 0.8; }
    .video-background iframe { width: 100%; height: 100%; border: none; }
    .video-background img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .video-background iframe:not([src]) + img { display: block; }
    /* Search bar and button styles */
    .dropdown-menu { position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #ccc; min-width: 250px; z-index: 1000; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); backdrop-filter: blur(5px); transition: opacity 0.3s; }
    .search-form { padding: 10px; }
    .input-group { display: flex; align-items: center; }
    .search-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 10px 0 0 10px; font-family: 'Comic Sans MS', Arial, sans-serif; background: #f9fbff; font-size: 1.1rem; }
    .input-group-btn { display: flex; }
    .btn { cursor: pointer; padding: 12px 18px; border: none; font-family: 'Comic Sans MS', Arial, sans-serif; font-size: 1.2rem; transition: background 0.2s, transform 0.2s, box-shadow 0.2s; border-radius: 10px; }
    .btn:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 0 12px #2ecc71; }
    .btn-bright-green { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .btn-clear { background: transparent; }
    .reset { background: #ccc; border-radius: 10px; }
    .search-submit::after { content: "üîç"; }
    .icon-bar { background: #fff; display: block; width: 22px; height: 2px; margin: 5px 0; }
    /* Server status dashboard */
    .server-status { background: linear-gradient(135deg, #e6f3ff, #d4eaff); padding: 2rem; border-radius: 12px; margin-top: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .status-card { background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .status-card .online { color: #2ecc71; font-weight: bold; }
    .status-card .offline { color: #e74c3c; font-weight: bold; }
    .status-card p { margin: 0.5rem 0; font-size: 1.2rem; }
    /* Level editor styles */
    .level-editor { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .level-editor canvas { width: 100%; height: 400px; border: 1px solid #ccc; border-radius: 10px; }
    .level-editor .controls { display: flex; gap: 1rem; margin-top: 1rem; }
    /* General styles */
    a { color: #2ecc71; text-decoration: none; }
    a:hover { color: #27ae60; }
    h1, h2, h3 { font-family: 'Comic Sans MS', Arial, sans-serif; color: #222; margin: 0.8rem 0; }
    button { font-family: 'Comic Sans MS', Arial, sans-serif; }
    .content-overlay { background: rgba(255, 255, 255, 0.9); padding: 1.5rem; border-radius: 12px; }
    .image-preview { max-width: 200px; height: auto; border-radius: 8px; margin: 0.5rem; }
    /* Ensure visibility and prevent sticking */
    * { box-sizing: border-box; }
    main { margin-left: 0; transition: margin-left 0.3s ease; }
    main.sidebar-open { margin-left: 300px; }
  </style>
</head>
<body class="lbp logged-out homepage" data-controller="home" data-ext-base-url="/api" data-context-path="">
  <div class="video-background">
    <iframe onload="this.parentNode.classList.add('loaded')" src="https://www.youtube.com/embed/qovNaHl-Ko4?autoplay=1&mute=1&loop=1&playlist=qovNaHl-Ko4&controls=0" allow="autoplay"></iframe>
    <img src="https://via.placeholder.com/1920x1080?text=LBP+Intro+Fallback" alt="Fallback">
  </div>
  <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞ Menu</button>
  <div class="bgr">
    <nav>
      <div class="navbar primary hidden-lg hidden-md hidden-sm" role="navigation">
        <div class="container">
          <div class="navbar pull-left logo">
            <a href="/" data-link><img src="https://via.placeholder.com/60?text=Logo" alt="relbp.me"></a>
          </div>
          <div class="navbar-header">
            <button type="button" class="navbar-toggle navigation-hotspot" onclick="toggleSidebar()">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
            </button>
            <div class="quick-search btn-group">
              <button type="button" class="btn btn-clear dropdown-toggle icon-text search sm" onclick="openSearch(event)"></button>
              <div class="dropdown-menu" style="display:none;" id="search-dropdown">
                <div class="search-form" data-stoppropagation="true">
                  <form method="GET" action="/search/v" autocomplete="off" onsubmit="return onSearch(event)">
                    <fieldset>
                      <div class="input-group">
                        <input type="text" name="q" class="search-input form-control" placeholder="Quick search">
                        <span class="input-group-btn">
                          <button class="reset" type="reset" style="display:none;"></button>
                          <button type="submit" class="btn btn-bright-green icon-text sm search search-submit"></button>
                        </span>
                      </div>
                    </fieldset>
                  </form>
                </div>
              </div>
            </div>
            <div class="autopilot">
              <button class="btn btn-clear icon-img icon-content sm playworld disabled" href="#autopilotmodalsignedout">Autopilot</button>
            </div>
          </div>
        </div>
      </div>
      <div class="secondary-wrapper hidden-xs">
        <div class="navbar secondary not-homepage container" role="navigation">
          <ul class="nav navbar-nav">
            <li id="home-link"><button class="btn btn-bright-green"><a href="/" data-link class="nav-link">Home</a></button></li>
            <li id="profile-link">
              <div class="autopilot hidden-xs"><button class="btn btn-clear icon-img icon-content sm playworld disabled">Autopilot</button></div>
              <div id="signin-link"><button class="btn btn-bright-green"><a href="/signin" data-link title="Sign in">Sign In</a></button></div>
              <button class="btn btn-bright-green"><a class="signed-out nav-link" href="/profile" data-link>My Profile</a></button>
            </li>
            <li id="videos-link"><button class="btn btn-bright-green"><a href="/videos" data-link class="nav-link">Videos</a></button></li>
            <li id="levels-link"><button class="btn btn-bright-green"><a href="/levels" data-link class="nav-link">Levels</a></button></li>
            <li id="community-link"><button class="btn btn-bright-green"><a href="/community" data-link class="nav-link">Community</a></button></li>
            <li id="tutorial-link"><button class="btn btn-bright-green"><a href="/videos/tutorial" data-link class="nav-link">Tutorials</a></button></li>
            <li id="copyright-link"><button class="btn btn-bright-green"><a href="/copyright" data-link class="nav-link">Copyright</a></button></li>
          </ul>
          <div class="quick-search btn-group hidden-xs">
            <button type="button" class="btn btn-clear dropdown-toggle icon-text search sm" onclick="openSearch(event)"></button>
            <div class="dropdown-menu" style="display:none;" id="search-dropdown-2">
              <div class="search-form" data-stoppropagation="true">
                <form method="GET" action="/search/v" autocomplete="off" onsubmit="return onSearch(event)">
                  <fieldset>
                    <div class="input-group">
                      <input type="text" name="q" class="search-input form-control" placeholder="Quick search">
                      <span class="input-group-btn">
                        <button class="reset" type="reset" style="display:none;"></button>
                        <button type="submit" class="btn btn-bright-green icon-text sm search search-submit"></button>
                      </span>
                    </div>
                  </fieldset>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </div>

  <div class="sidebar-offcanvas" id="sidebar">
    <div class="pull-left width100 clear">
      <ul class="nav top-oc">
        <li class="home-link"><button class="btn btn-bright-green"><a href="/" data-link>Home</a></button></li>
        <li class="community-link"><button class="btn btn-bright-green"><a href="/community" data-link>Community</a></button></li>
        <li class="levels-link"><button class="btn btn-bright-green"><a href="/levels" data-link>Levels</a></button></li>
        <li class="video-link"><button class="btn btn-bright-green"><a href="/videos" data-link>Videos</a></button></li>
        <li class="tutorial-link"><button class="btn btn-bright-green"><a href="/videos/tutorial" data-link>Tutorials</a></button></li>
        <li class="profile-link"><button class="btn btn-bright-green"><a href="/profile" data-link>My Profile</a></button></li>
        <li class="signin-link"><button class="btn btn-bright-green"><a href="/signin" data-link>Sign In</a></button></li>
        <li class="signout-link"><button class="btn btn-bright-green"><a href="/signout" data-link>Sign Out</a></button></li>
        <li class="copyright-link"><button class="btn btn-bright-green"><a href="/copyright" data-link>Copyright</a></button></li>
        <li class="lbp-link"><button class="btn btn-bright-green"><a href="http://littlebigplanet.com/" target="_blank">LBP.com</a></button></li>
      </ul>
    </div>
  </div>

  <main id="app" class="container">
    <!-- Dynamic content will load here -->
  </main>

  <script>
    // Backend (Node.js/Express with forced LBP 3 server connection and extended functionality)
    if (typeof require !== 'undefined') {
      const express = require('express');
      const cors = require('cors');
      const path = require('path');
      const sanitizeHtml = require('sanitize-html');
      const app = express();
      app.use(cors());
      app.use(express.json());
      // In-memory storage for demo (replace with database in production)
      let usersDB = [];
      let levelsDB = [];
      let imagesDB = [];
      // Game server configuration for Beacon/Project Lighthouse
      const BEACON_SERVER = 'https://beacon.lbpunion.com';
      const gameConfig = {
        serverUrl: BEACON_SERVER,
        authEndpoint: `${BEACON_SERVER}/api/v1/auth`,
        levelsEndpoint: `${BEACON_SERVER}/api/v1/levels`,
        profilesEndpoint: `${BEACON_SERVER}/api/v1/profiles`,
        sanitizeOptions: {
          allowedTags: [],
          allowedAttributes: {}
        }
      };
      // Connect to Beacon server for LBP 3 integration
      async function connectToBeacon() {
        try {
          const response = await fetch(`${gameConfig.serverUrl}/api/v1/status`, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          if (!response.ok) throw new Error('Beacon server unavailable');
          return { status: 'Connected', message: 'Successfully connected to Beacon server' };
        } catch (err) {
          console.error('Beacon connection failed:', err);
          return { status: 'Failed', message: 'Ensure game client is patched for Beacon' };
        }
      }
      connectToBeacon().then(result => console.log('Beacon:', result.status));
      // API endpoint for homepage data
      app.get('/api/homepage', (req, res) => {
        res.json({ title: 'Welcome to relbp.me', description: 'A vibrant, secure LittleBigPlanet 3 community!' });
      });
      // API endpoint for fetching levels
      app.get('/api/levels', async (req, res) => {
        try {
          const response = await fetch(gameConfig.levelsEndpoint, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          const data = await response.json();
          res.json(data.map(item => ({
            id: sanitizeHtml(item.id, gameConfig.sanitizeOptions),
            name: sanitizeHtml(item.name, gameConfig.sanitizeOptions),
            summary: sanitizeHtml(item.summary, gameConfig.sanitizeOptions),
            description: sanitizeHtml(item.description, gameConfig.sanitizeOptions),
            creator: sanitizeHtml(item.creator, gameConfig.sanitizeOptions),
            screenshot: item.screenshot || null
          })));
        } catch (err) {
          res.json(levelsDB.length ? levelsDB : [
            { id: '1', name: 'Sackboy Adventure', summary: 'A fun level', description: 'Explore a creative world.', creator: 'user1', screenshot: null },
            { id: '2', name: 'Dreamscape Dash', summary: 'Epic challenge', description: 'Challenge your skills.', creator: 'user2', screenshot: null }
          ]);
        }
      });
      // API endpoint for saving levels
      app.post('/api/levels', (req, res) => {
        const { name, summary, description, creator, objects, screenshot } = req.body;
        const sanitizedLevel = {
          id: `level_${Date.now()}_${Math.random().toString(36).slice(2)}`,
          name: sanitizeHtml(name, gameConfig.sanitizeOptions),
          summary: sanitizeHtml(summary, gameConfig.sanitizeOptions),
          description: sanitizeHtml(description, gameConfig.sanitizeOptions),
          creator: sanitizeHtml(creator, gameConfig.sanitizeOptions),
          objects: objects.map(obj => ({
            type: sanitizeHtml(obj.type, gameConfig.sanitizeOptions),
            x: parseFloat(obj.x) || 0,
            y: parseFloat(obj.y) || 0
          })),
          screenshot: screenshot ? sanitizeHtml(screenshot, gameConfig.sanitizeOptions) : null
        };
        levelsDB.push(sanitizedLevel);
        res.json({ success: true, id: sanitizedLevel.id });
      });
      // API endpoint for fetching videos
      app.get('/api/videos', (req, res) => {
        res.json([
          { id: '1', title: 'Epic Gameplay', description: 'Gameplay showcase.', creator: 'user1', thumbnail: null },
          { id: '2', title: 'Creative Builds', description: 'Amazing creations.', creator: 'user2', thumbnail: null }
        ]);
      });
      // API endpoint for tutorials
      app.get('/api/videos/tutorial', (req, res) => {
        res.json([
          { id: '1', title: 'Level Creation 101', description: 'Learn to create levels.', creator: 'user1', thumbnail: null }
        ]);
      });
      // API endpoint for community data
      app.get('/api/community', (req, res) => {
        res.json([
          { name: 'Sackboy Hub', description: 'Connect with LBP fans!', members: usersDB.length }
        ]);
      });
      // API endpoint for user profiles
      app.get('/api/users/:username', async (req, res) => {
        const username = sanitizeHtml(req.params.username, gameConfig.sanitizeOptions);
        try {
          const response = await fetch(`${gameConfig.profilesEndpoint}/${username}`, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          const data = await response.json();
          res.json({
            username,
            bio: sanitizeHtml(data.bio, gameConfig.sanitizeOptions),
            avatar: data.avatar || null,
            levels: data.levels || [],
            screenshots: data.screenshots || []
          });
        } catch (err) {
          const user = usersDB.find(u => u.username === username) || {
            username,
            bio: `Bio for ${username}`,
            avatar: null,
            levels: [],
            screenshots: []
          };
          res.json(user);
        }
      });
      // API endpoint for saving user profiles
      app.post('/api/users', (req, res) => {
        const { username, bio, avatar } = req.body;
        const sanitizedUser = {
          username: sanitizeHtml(username, gameConfig.sanitizeOptions),
          bio: sanitizeHtml(bio, gameConfig.sanitizeOptions),
          avatar: avatar ? sanitizeHtml(avatar, gameConfig.sanitizeOptions) : null,
          levels: [],
          screenshots: []
        };
        const existing = usersDB.find(u => u.username === sanitizedUser.username);
        if (existing) {
          Object.assign(existing, sanitizedUser);
        } else {
          usersDB.push(sanitizedUser);
        }
        res.json({ success: true, username: sanitizedUser.username });
      });
      // API endpoint for user session
      app.get('/api/user/session', (req, res) => {
        res.json({ loggedIn: false, username: '' });
      });
      // API endpoint for sign-in
      app.post('/api/signin', (req, res) => {
        const { username, password } = req.body;
        const sanitizedUsername = sanitizeHtml(username, gameConfig.sanitizeOptions);
        if (sanitizedUsername && password) {
          const user = usersDB.find(u => u.username === sanitizedUsername) || {
            username: sanitizedUsername,
            bio: `New user ${sanitizedUsername}`,
            avatar: null,
            levels: [],
            screenshots: []
          };
          if (!usersDB.find(u => u.username === sanitizedUsername)) {
            usersDB.push(user);
          }
          res.json({ success: true, username: sanitizedUsername });
        } else {
          res.status(400).json({ success: false, message: 'Invalid credentials' });
        }
      });
      // API endpoint for search
      app.get('/api/search/:type', (req, res) => {
        const type = sanitizeHtml(req.params.type, gameConfig.sanitizeOptions);
        const q = sanitizeHtml(req.query.q || '', gameConfig.sanitizeOptions);
        const tab = type === 'u' ? 'users' : type === 'l' ? 'levels' : 'videos';
        let results = [];
        if (tab === 'users') {
          results = usersDB.filter(u => u.username.includes(q)).map(u => ({ username: u.username }));
        } else if (tab === 'levels') {
          results = levelsDB.filter(l => l.name.includes(q)).map(l => ({ name: l.name }));
        } else {
          results = [{ title: `Video result for ${q}` }];
        }
        res.json(results);
      });
      // API endpoint for specific levels
      app.get('/api/levels/:id', async (req, res) => {
        const id = sanitizeHtml(req.params.id, gameConfig.sanitizeOptions);
        try {
          const response = await fetch(`${gameConfig.levelsEndpoint}/${id}`, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          const data = await response.json();
          res.json({
            name: sanitizeHtml(data.name, gameConfig.sanitizeOptions),
            description: sanitizeHtml(data.description, gameConfig.sanitizeOptions),
            creator: sanitizeHtml(data.creator, gameConfig.sanitizeOptions),
            screenshot: data.screenshot || null
          });
        } catch (err) {
          const level = levelsDB.find(l => l.id === id) || {
            name: `Level ${id}`,
            description: `Description for level ${id}`,
            creator: 'unknown',
            screenshot: null
          };
          res.json(level);
        }
      });
      // API endpoint for specific videos
      app.get('/api/videos/:id', (req, res) => {
        const id = sanitizeHtml(req.params.id, gameConfig.sanitizeOptions);
        res.json({
          title: `Video ${id}`,
          description: `Description for video ${id}`,
          creator: 'unknown',
          thumbnail: null
        });
      });
      // API endpoint for image/screenshot upload
      app.post('/api/images', (req, res) => {
        const { userId, imageData, type } = req.body;
        const sanitizedImage = {
          id: `img_${Date.now()}_${Math.random().toString(36).slice(2)}`,
          userId: sanitizeHtml(userId, gameConfig.sanitizeOptions),
          imageData: sanitizeHtml(imageData, gameConfig.sanitizeOptions),
          type: sanitizeHtml(type, gameConfig.sanitizeOptions)
        };
        imagesDB.push(sanitizedImage);
        const user = usersDB.find(u => u.username === sanitizedImage.userId);
        if (user) {
          user.screenshots = user.screenshots || [];
          user.screenshots.push(sanitizedImage.id);
        }
        res.json({ success: true, id: sanitizedImage.id });
      });
      // API endpoint for server status
      app.get('/api/server-status', async (req, res) => {
        try {
          const response = await fetch(`${BEACON_SERVER}/api/v1/status`, {
            headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' }
          });
          const data = await response.json();
          res.json({
            beacon: {
              status: sanitizeHtml(data.status, gameConfig.sanitizeOptions),
              players: parseInt(data.players || 0),
              levels: parseInt(data.levels || 0)
            },
            lastChecked: new Date().toISOString()
          });
        } catch (err) {
          res.json({
            beacon: { status: 'Offline', players: 0, levels: 0 },
            lastChecked: new Date().toISOString()
          });
        }
      });
      // Serve static file
      app.get('*', (req, res) => {
        res.sendFile(path.join(__dirname, 'index.html'));
      });
      const PORT = process.env.PORT || 10000;
      app.listen(PORT, '0.0.0.0', () => console.log(`Server on port ${PORT}`));
    }

    // Frontend (Client-side routing and extended functionality)
    const API = '/api';
    // Initialize localStorage for demo persistence
    const db = {
      saveLevel: (level) => {
        const levels = JSON.parse(localStorage.getItem('levels') || '[]');
        levels.push(level);
        localStorage.setItem('levels', JSON.stringify(levels));
      },
      getLevels: () => JSON.parse(localStorage.getItem('levels') || '[]'),
      saveUser: (user) => {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const index = users.findIndex(u => u.username === user.username);
        if (index >= 0) {
          users[index] = user;
        } else {
          users.push(user);
        }
        localStorage.setItem('users', JSON.stringify(users));
      },
      getUser: (username) => {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        return users.find(u => u.username === username) || null;
      },
      saveImage: (image) => {
        const images = JSON.parse(localStorage.getItem('images') || '[]');
        images.push(image);
        localStorage.setItem('images', JSON.stringify(images));
      },
      getImages: (userId) => {
        const images = JSON.parse(localStorage.getItem('images') || '[]');
        return images.filter(img => img.userId === userId);
      }
    };

    // Sidebar toggle functionality
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const main = document.querySelector('main');
      sidebar.classList.toggle('open');
      main.classList.toggle('sidebar-open');
      sidebar.style.backdropFilter = sidebar.classList.contains('open') ? 'blur(10px)' : 'none';
    }

    // Search bar functionality
    function openSearch(e) {
      const d = e.target.closest('.quick-search').querySelector('.dropdown-menu');
      d.style.display = d.style.display === 'block' ? 'none' : 'block';
    }

    function onSearch(e) {
      e.preventDefault();
      let q = e.target.q.value.replace(/[<>]/g, '');
      if (!q) return false;
      history.pushState(null, null, `/search/v?q=${encodeURIComponent(q)}`);
      router();
      return false;
    }

    // Level editor functionality
    function initLevelEditor(container, levelId, existingLevel = null) {
      const canvas = document.createElement('canvas');
      canvas.width = 800;
      canvas.height = 400;
      container.appendChild(canvas);
      const ctx = canvas.getContext('2d');
      const objects = existingLevel ? existingLevel.objects : [];
      let selectedType = 'platform';
      let isDrawing = false;
      // Draw level editor canvas
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#87ceeb';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        objects.forEach(obj => {
          ctx.fillStyle = obj.type === 'platform' ? '#8b4513' : '#ff4500';
          ctx.fillRect(obj.x, obj.y, 50, 50);
        });
      }
      // Mouse events for level editing
      canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        objects.push({
          type: selectedType,
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        });
        draw();
      });
      canvas.addEventListener('mousemove', (e) => {
        if (isDrawing) {
          const rect = canvas.getBoundingClientRect();
          objects.push({
            type: selectedType,
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
          });
          draw();
        }
      });
      canvas.addEventListener('mouseup', () => {
        isDrawing = false;
      });
      // Controls for level editor
      const controls = document.createElement('div');
      controls.className = 'controls';
      controls.innerHTML = `
        <select id="object-type">
          <option value="platform">Platform</option>
          <option value="hazard">Hazard</option>
        </select>
        <input type="text" id="level-name" placeholder="Level Name" />
        <input type="text" id="level-summary" placeholder="Summary" />
        <textarea id="level-description" placeholder="Description"></textarea>
        <input type="file" id="level-screenshot" accept="image/*" />
        <button class="btn btn-bright-green">Save Level</button>
      `;
      container.appendChild(controls);
      controls.querySelector('#object-type').addEventListener('change', (e) => {
        selectedType = e.target.value;
      });
      controls.querySelector('button').addEventListener('click', async () => {
        const name = controls.querySelector('#level-name').value;
        const summary = controls.querySelector('#level-summary').value;
        const description = controls.querySelector('#level-description').value;
        const screenshot = controls.querySelector('#level-screenshot').files[0];
        let screenshotData = null;
        if (screenshot) {
          const reader = new FileReader();
          reader.onload = async () => {
            screenshotData = reader.result;
            const level = { name, summary, description, creator: getCurrentUser() || 'anonymous', objects, screenshot: screenshotData };
            db.saveLevel(level);
            try {
              const res = await fetch(`${API}/levels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(level)
              });
              const result = await res.json();
              alert(`Level saved with ID: ${result.id}`);
              history.pushState(null, null, `/l/${result.id}`);
              router();
            } catch (err) {
              alert('Failed to save level to server, saved locally.');
            }
          };
          reader.readAsDataURL(screenshot);
        } else {
          const level = { name, summary, description, creator: getCurrentUser() || 'anonymous', objects, screenshot: null };
          db.saveLevel(level);
          try {
            const res = await fetch(`${API}/levels`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(level)
            });
            const result = await res.json();
            alert(`Level saved with ID: ${result.id}`);
            history.pushState(null, null, `/l/${result.id}`);
            router();
          } catch (err) {
            alert('Failed to save level to server, saved locally.');
          }
        }
      });
      draw();
    }

    // Current user management
    let currentUser = null;
    function setCurrentUser(username) {
      currentUser = username;
      localStorage.setItem('currentUser', username);
    }
    function getCurrentUser() {
      return localStorage.getItem('currentUser');
    }

    const app = document.getElementById('app');

    // Route: Homepage
    async function routeHome() {
      try {
        const [res, statusRes] = await Promise.all([
          fetch(`${API}/homepage`).catch(() => ({ ok: false })),
          fetch(`${API}/server-status`).catch(() => ({ ok: false }))
        ]);
        const d = res.ok ? await res.json() : { title: 'Welcome', description: 'Error loading homepage' };
        const status = statusRes.ok ? await statusRes.json() : { beacon: { status: 'Offline', players: 0, levels: 0 }, lastChecked: new Date().toISOString() };
        app.innerHTML = `
          <div class="content-overlay">
            <div class="sackboy"></div>
            <h1>${d.title}</h1>
            <p>${d.description}</p>
            <div class="server-status">
              <h2>Server Status</h2>
              <div class="status-card">
                <p><strong>Beacon Server</strong>: <span class="${status.beacon.status.toLowerCase()}">${status.beacon.status}</span></p>
                <p>Players Online: ${status.beacon.players}</p>
                <p>Levels Available: ${status.beacon.levels}</p>
                <p>Last Checked: ${new Date(status.lastChecked).toLocaleString()}</p>
              </div>
              <p><a href="https://discord.com/invite/lbpunion" target="_blank">Join our Discord for live updates!</a></p>
              <button class="btn btn-bright-green" onclick="connectToGameServer()">Connect to LBP 3 Servers</button>
            </div>
            <button class="btn btn-bright-green"><a href="/create-level" data-link>Create a Level</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load homepage: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Levels
    async function routeLevels() {
      try {
        const res = await fetch(`${API}/levels`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : db.getLevels();
        app.innerHTML = `
          <div class="content-overlay">
            <h1>Levels</h1>
            ${d.length ? d.map(l => `
              <div class="card">
                <h3><a href="/l/${l.id}" data-link>${l.name}</a></h3>
                <p>${l.summary}</p>
                ${l.screenshot ? `<img src="${l.screenshot}" class="image-preview" alt="Level screenshot" />` : ''}
                <p>Created by: ${l.creator}</p>
                <button class="btn btn-bright-green">Play Level</button>
              </div>
            `).join('') : '<p>No levels available</p>'}
            <button class="btn btn-bright-green"><a href="/create-level" data-link>Create a Level</a></button>
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load levels: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Videos
    async function routeVideos() {
      try {
        const res = await fetch(`${API}/videos`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `
          <div class="content-overlay">
            <h1>Videos</h1>
            ${d.length ? d.map(v => `
              <div class="card">
                <h3><a href="/v/${v.id}" data-link>${v.title}</a></h3>
                <p>${v.description}</p>
                ${v.thumbnail ? `<img src="${v.thumbnail}" class="image-preview" alt="Video thumbnail" />` : ''}
                <p>Created by: ${v.creator}</p>
                <button class="btn btn-bright-green">Watch Video</button>
              </div>
            `).join('') : '<p>No videos available</p>'}
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load videos: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Tutorials
    async function routeTutorials() {
      try {
        const res = await fetch(`${API}/videos/tutorial`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `
          <div class="content-overlay">
            <h1>Tutorials</h1>
            ${d.length ? d.map(v => `
              <div class="card">
                <h3>${v.title}</h3>
                <p>${v.description}</p>
                ${v.thumbnail ? `<img src="${v.thumbnail}" class="image-preview" alt="Tutorial thumbnail" />` : ''}
                <p>Created by: ${v.creator}</p>
                <button class="btn btn-bright-green">Watch Tutorial</button>
              </div>
            `).join('') : '<p>No tutorials available</p>'}
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load tutorials: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Community
    async function routeCommunity() {
      try {
        const res = await fetch(`${API}/community`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `
          <div class="content-overlay">
            <h1>Community</h1>
            ${d.length ? d.map(c => `
              <div class="card">
                <h3>${c.name}</h3>
                <p>${c.description}</p>
                <p>Members: ${c.members}</p>
                <button class="btn btn-bright-green">Join Community</button>
              </div>
            `).join('') : '<p>No community data available</p>'}
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load community: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: User profile
    async function routeUser(username) {
      try {
        const res = await fetch(`${API}/users/${encodeURIComponent(username.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const u = res.ok ? await res.json() : db.getUser(username) || { username: 'Unknown', bio: 'User not found', avatar: null, levels: [], screenshots: [] };
        const images = db.getImages(username);
        app.innerHTML = `
          <div class="content-overlay">
            <h1>${u.username}</h1>
            ${u.avatar ? `<img src="${u.avatar}" class="image-preview" alt="User avatar" />` : ''}
            <p>${u.bio}</p>
            <h3>Levels Created</h3>
            ${u.levels.length ? u.levels.map(id => `<p><a href="/l/${id}" data-link>Level ${id}</a></p>`).join('') : '<p>No levels created</p>'}
            <h3>Screenshots</h3>
            ${images.length ? images.map(img => `<img src="${img.imageData}" class="image-preview" alt="Screenshot" />`).join('') : '<p>No screenshots</p>'}
            <button class="btn btn-bright-green"><a href="/edit-profile" data-link>Edit Profile</a></button>
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load user: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Video
    async function routeVideo(id) {
      try {
        const res = await fetch(`${API}/videos/${encodeURIComponent(id.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const v = res.ok ? await res.json() : { title: 'Unknown', description: 'Video not found', creator: 'unknown', thumbnail: null };
        app.innerHTML = `
          <div class="content-overlay">
            <h1>${v.title}</h1>
            ${v.thumbnail ? `<img src="${v.thumbnail}" class="image-preview" alt="Video thumbnail" />` : ''}
            <p>${v.description}</p>
            <p>Created by: ${v.creator}</p>
            <button class="btn btn-bright-green">Watch Video</button>
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load video: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Level
    async function routeLevel(id) {
      try {
        const res = await fetch(`${API}/levels/${encodeURIComponent(id.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const l = res.ok ? await res.json() : db.getLevels().find(l => l.id === id) || { name: 'Unknown', description: 'Level not found', creator: 'unknown', screenshot: null };
        app.innerHTML = `
          <div class="content-overlay">
            <h1>${l.name}</h1>
            ${l.screenshot ? `<img src="${l.screenshot}" class="image-preview" alt="Level screenshot" />` : ''}
            <p>${l.description}</p>
            <p>Created by: ${l.creator}</p>
            <button class="btn btn-bright-green">Play Level</button>
            <button class="btn btn-bright-green"><a href="/edit-level/${id}" data-link>Edit Level</a></button>
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load level: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Profile
    async function routeProfile() {
      try {
        const res = await fetch(`${API}/user/session`, { credentials: 'include' }).catch(() => ({ ok: false }));
        const u = res.ok ? await res.json() : { loggedIn: false };
        if (u.loggedIn) {
          const user = db.getUser(u.username) || { username: u.username, bio: 'No bio set', avatar: null, levels: [], screenshots: [] };
          const images = db.getImages(u.username);
          app.innerHTML = `
            <div class="content-overlay">
              <h1>${user.username}</h1>
              ${user.avatar ? `<img src="${user.avatar}" class="image-preview" alt="User avatar" />` : ''}
              <p>${user.bio}</p>
              <h3>Levels Created</h3>
              ${user.levels.length ? user.levels.map(id => `<p><a href="/l/${id}" data-link>Level ${id}</a></p>`).join('') : '<p>No levels created</p>'}
              <h3>Screenshots</h3>
              ${images.length ? images.map(img => `<img src="${img.imageData}" class="image-preview" alt="Screenshot" />`).join('') : '<p>No screenshots</p>'}
              <button class="btn btn-bright-green"><a href="/edit-profile" data-link>Edit Profile</a></button>
              <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
            </div>
          `;
        } else {
          app.innerHTML = `<div class="content-overlay"><p>Not signed in. <a href="/signin" data-link>Sign in</a></p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
        }
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load profile: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Search
    async function routeSearch(type, q) {
      try {
        const tab = type === 'u' ? 'users' : type === 'l' ? 'levels' : 'videos';
        const res = await fetch(`${API}/search/${type}?q=${encodeURIComponent(q.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const d = res.ok ? await res.json() : [];
        app.innerHTML = `
          <div class="content-overlay">
            <h1>Search ${tab} for "${q}"</h1>
            ${d.length ? d.map(i => `
              <div class="card">
                <h3>${i.username || i.name || i.title}</h3>
                <button class="btn btn-bright-green">View ${tab === 'users' ? 'Profile' : tab === 'levels' ? 'Level' : 'Video'}</button>
              </div>
            `).join('') : '<p>No results found</p>'}
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load search: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Welcome
    async function routeWelcome() {
      app.innerHTML = `
        <div class="content-overlay">
          <h1>Welcome!</h1>
          <p>You just signed in.</p>
          <button class="btn btn-bright-green"><a href="/" data-link>Go to Home</a></button>
        </div>
      `;
    }

    // Route: Sign In
    async function routeSignIn() {
      app.innerHTML = `
        <div class="content-overlay">
          <h1>Sign In</h1>
          <p>Connect to LBP 3 servers via Beacon.</p>
          <input type="text" id="username" placeholder="Username" />
          <input type="password" id="password" placeholder="Password" />
          <button class="btn btn-bright-green" onclick="signIn()">Sign In</button>
          <button class="btn btn-bright-green" onclick="connectToGameServer()">Sign In with Beacon</button>
          <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
        </div>
      `;
    }

    // Sign-in functionality
    async function signIn() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        const res = await fetch(`${API}/signin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const result = await res.json();
        if (result.success) {
          setCurrentUser(result.username);
          history.pushState(null, null, '/welcome');
          router();
        } else {
          alert('Sign-in failed: ' + result.message);
        }
      } catch (err) {
        alert('Sign-in error: ' + err.message);
      }
    }

    // Route: Sign Out
    async function routeSignOut() {
      setCurrentUser(null);
      app.innerHTML = `
        <div class="content-overlay">
          <h1>Sign Out</h1>
          <p>You have been signed out.</p>
          <button class="btn btn-bright-green"><a href="/" data-link>Return to Home</a></button>
        </div>
      `;
    }

    // Route: Copyright
    async function routeCopyright() {
      app.innerHTML = `
        <div class="content-overlay">
          <h1>Copyright</h1>
          <p>¬© 2025 relbp.me. All rights reserved. This site is an original creation by the relbp.me team, dedicated to the LittleBigPlanet 3 community. Not affiliated with Sony Interactive Entertainment or Media Molecule.</p>
          <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
        </div>
      `;
    }

    // Route: Create Level
    async function routeCreateLevel() {
      app.innerHTML = `
        <div class="content-overlay">
          <h1>Create a Level</h1>
          <div class="level-editor"></div>
          <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
        </div>
      `;
      initLevelEditor(app.querySelector('.level-editor'), null);
    }

    // Route: Edit Level
    async function routeEditLevel(id) {
      try {
        const res = await fetch(`${API}/levels/${encodeURIComponent(id.replace(/[<>]/g, ''))}`).catch(() => ({ ok: false }));
        const l = res.ok ? await res.json() : db.getLevels().find(l => l.id === id) || { name: 'Unknown', description: 'Level not found', creator: 'unknown', objects: [], screenshot: null };
        app.innerHTML = `
          <div class="content-overlay">
            <h1>Edit Level: ${l.name}</h1>
            <div class="level-editor"></div>
            <button class="btn btn-bright-green"><a href="/l/${id}" data-link>View Level</a></button>
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
        initLevelEditor(app.querySelector('.level-editor'), id, l);
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load level: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Route: Edit Profile
    async function routeEditProfile() {
      const username = getCurrentUser();
      if (!username) {
        app.innerHTML = `
          <div class="content-overlay">
            <h1>Error</h1>
            <p>Please sign in to edit your profile.</p>
            <button class="btn btn-bright-green"><a href="/signin" data-link>Sign In</a></button>
            <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
          </div>
        `;
        return;
      }
      const user = db.getUser(username) || { username, bio: '', avatar: null };
      app.innerHTML = `
        <div class="content-overlay">
          <h1>Edit Profile: ${username}</h1>
          <input type="text" id="bio" value="${user.bio}" placeholder="Bio" />
          <input type="file" id="avatar" accept="image/*" />
          ${user.avatar ? `<img src="${user.avatar}" class="image-preview" alt="Current avatar" />` : ''}
          <input type="file" id="screenshot" accept="image/*" multiple />
          <button class="btn btn-bright-green" onclick="saveProfile()">Save Profile</button>
          <button class="btn btn-bright-green"><a href="/profile" data-link>View Profile</a></button>
          <button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button>
        </div>
      `;
    }

    // Save profile functionality
    async function saveProfile() {
      const username = getCurrentUser();
      if (!username) {
        alert('Please sign in to save profile.');
        return;
      }
      const bio = document.getElementById('bio').value;
      const avatarFile = document.getElementById('avatar').files[0];
      const screenshotFiles = document.getElementById('screenshot').files;
      let avatarData = null;
      if (avatarFile) {
        const reader = new FileReader();
        reader.onload = async () => {
          avatarData = reader.result;
          const user = { username, bio, avatar: avatarData, levels: [], screenshots: [] };
          db.saveUser(user);
          try {
            await fetch(`${API}/users`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(user)
            });
          } catch (err) {
            console.error('Failed to save user to server:', err);
          }
          for (let screenshot of screenshotFiles) {
            const reader = new FileReader();
            reader.onload = async () => {
              const imageData = reader.result;
              db.saveImage({ userId: username, imageData, type: 'screenshot' });
              try {
                await fetch(`${API}/images`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ userId: username, imageData, type: 'screenshot' })
                });
              } catch (err) {
                console.error('Failed to save image to server:', err);
              }
            };
            reader.readAsDataURL(screenshot);
          }
          alert('Profile saved!');
          history.pushState(null, null, '/profile');
          router();
        };
        reader.readAsDataURL(avatarFile);
      } else {
        const user = { username, bio, avatar: null, levels: [], screenshots: [] };
        db.saveUser(user);
        try {
          await fetch(`${API}/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(user)
          });
        } catch (err) {
          console.error('Failed to save user to server:', err);
        }
        for (let screenshot of screenshotFiles) {
          const reader = new FileReader();
          reader.onload = async () => {
            const imageData = reader.result;
            db.saveImage({ userId: username, imageData, type: 'screenshot' });
            try {
              await fetch(`${API}/images`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: username, imageData, type: 'screenshot' })
              });
            } catch (err) {
              console.error('Failed to save image to server:', err);
            }
          };
          reader.readAsDataURL(screenshot);
        }
        alert('Profile saved!');
        history.pushState(null, null, '/profile');
        router();
      }
    }

    // Connect to Beacon server
    async function connectToGameServer() {
      try {
        const response = await fetch('https://beacon.lbpunion.com/api/v1/auth', {
          method: 'POST',
          headers: { 'User-Agent': 'relbp.me/1.0', 'X-LBP-Client': 'LBP3-Web' },
          body: JSON.stringify({ client: 'web' })
        });
        if (!response.ok) throw new Error('Authentication failed');
        alert('Connected to Beacon server! Patch your LBP 3 client (PS3/RPCS3/Vita) per LBP Union tutorials: https://www.lbpunion.com');
      } catch (err) {
        alert('Failed to connect to Beacon server. Ensure your LBP 3 client is patched: https://www.lbpunion.com');
      }
    }

    // Router for client-side navigation
    async function router() {
      app.innerHTML = `<div class="content-overlay"><p>Loading...</p></div>`;
      try {
        const path = location.pathname;
        const qs = location.search;
        document.querySelector('.video-background').style.display = path === '/' || path === '' ? 'block' : 'none';
        if (path === '/' || path === '') return routeHome();
        if (path === '/levels') return routeLevels();
        if (path === '/videos') return routeVideos();
        if (path === '/videos/tutorial') return routeTutorials();
        if (path === '/community') return routeCommunity();
        if (path === '/profile') return routeProfile();
        if (path === '/welcome') return routeWelcome();
        if (path === '/signin') return routeSignIn();
        if (path === '/signout') return routeSignOut();
        if (path === '/copyright') return routeCopyright();
        if (path === '/create-level') return routeCreateLevel();
        let m;
        if (m = path.match(/^\/u\/([^\/]+)$/)) return routeUser(m[1]);
        if (m = path.match(/^\/v\/([^\/]+)$/)) return routeVideo(m[1]);
        if (m = path.match(/^\/l\/([^\/]+)$/)) return routeLevel(m[1]);
        if (m = path.match(/^\/edit-level\/([^\/]+)$/)) return routeEditLevel(m[1]);
        if (path === '/edit-profile') return routeEditProfile();
        if (m = path.match(/^\/search\/([luv])/) && qs.match(/q=([^&]+)/)) {
          return routeSearch(m[1], decodeURIComponent(qs.split('q=')[1]));
        }
        app.innerHTML = `<div class="content-overlay"><h1>404 Not Found</h1><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      } catch (err) {
        app.innerHTML = `<div class="content-overlay"><h1>Error</h1><p>Failed to load content: ${err.message}</p><button class="btn btn-bright-green"><a href="/" data-link>Back to Home</a></button></div>`;
      }
    }

    // Event listeners for navigation
    document.body.addEventListener('click', e => {
      const a = e.target.closest('a[data-link]');
      if (a) {
        e.preventDefault();
        history.pushState(null, null, a.getAttribute('href'));
        router();
      }
    });

    window.addEventListener('popstate', router);

    // Initialize router
    router();
  </script>
</body>
</html>
</html>
